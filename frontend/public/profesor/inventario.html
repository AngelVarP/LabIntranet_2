<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesor - Inventario Disponible</title>
    <link rel="stylesheet" href="../../assets/css/normalize.css">
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/dashboard.css">
    <link rel="stylesheet" href="../../assets/css/table.css">
    <link rel="stylesheet" href="../../assets/css/profesor.css"> 
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../../assets/img/logoLab.png" alt="Intranet Logo" class="logo">
                <h3>Profesor</h3>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="practicas.html">Prácticas</a></li>
                    <li><a href="inventario.html" class="active">Inventario</a></li>
                    <li><a href="reportes.html">Reportes</a></li>
                    <li><a href="../../public/login.html" class="logout">Cerrar Sesión</a></li>
                </ul>
            </nav>
        </div>

        <div class="main-content">
            <h1>Inventario de Materiales Disponible</h1>
            <p>Consulta el stock actual antes de generar una práctica.</p>
            
            <div class="topbar">
                <div class="actions">
                    <input type="text" id="buscar-producto" placeholder="Buscar producto..." style="width: 300px;"> 
                    <select id="filtrar-categoria" style="width: 200px;"> 
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
            </div>

            <table id="tabla-inventario" class="table"> 
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Producto</th>
                        <th>Categoría</th>
                        <th>Unidad</th>
                        <th>Stock</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" style="text-align: center;">Cargando inventario...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    const API = "/LabIntranet_2/backend/api";
    const TOKEN = localStorage.getItem("token");
    const tabla = document.querySelector("#tabla-inventario tbody");
    const buscar = document.getElementById("buscar-producto");
    const filtro = document.getElementById("filtrar-categoria");

    let productos = [];
    let categorias = [];

    async function cargarCategorias(){
        const r = await fetch(`${API}/categorias/listar.php`,{headers:{Authorization:`Bearer ${TOKEN}`}});
        const data = await r.json();
        categorias = data;
        filtro.innerHTML = '<option value="">Todas las categorías</option>';
        data.forEach(c=>{
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.nombre;
            filtro.appendChild(opt);
        });
    }

    async function cargarProductos(){
        tabla.innerHTML = '<tr><td colspan="5" style="text-align:center;">Cargando...</td></tr>';
        const r = await fetch(`${API}/productos/listar.php`,{headers:{Authorization:`Bearer ${TOKEN}`}});
        const data = await r.json();
        productos = data;
        renderTabla();
    }

    function renderTabla(){
        tabla.innerHTML = "";
        const txt = buscar.value.toLowerCase();
        const cat = filtro.value;
        productos
            .filter(p => (p.nombre.toLowerCase().includes(txt) || (p.descripcion||"").toLowerCase().includes(txt)))
            .filter(p => cat==="" || p.categoria_id==cat || p.categoria==cat)
            .forEach(p=>{
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${p.categoria || "-"}</td>
                    <td>${p.unidad}</td>
                    <td>${p.stock}</td>`;
                tabla.appendChild(tr);
            });
        if(tabla.innerHTML===""){
            tabla.innerHTML='<tr><td colspan="5" style="text-align:center;">No hay productos</td></tr>';
        }
    }

    buscar.addEventListener("input", renderTabla);
    filtro.addEventListener("change", renderTabla);

    cargarCategorias();
    cargarProductos();
    </script>
</body>
</html>
